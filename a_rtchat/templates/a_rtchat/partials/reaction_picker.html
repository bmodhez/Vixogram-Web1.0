{% comment %}
Trigger placed beside the message bubble.
For UX: click '+' opens the emoji bar.
{% endcomment %}

<div data-msg-actions class="relative flex items-center gap-1 transition duration-150 ease-out opacity-0 pointer-events-none sm:group-hover:opacity-100 sm:group-hover:pointer-events-auto">
    <button
        type="button"
        class="h-8 w-8 inline-flex items-center justify-center rounded-full border border-gray-300 bg-gray-200/90 text-gray-800 hover:bg-gray-300/90 transition duration-150 ease-out hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 dark:border-transparent dark:bg-transparent dark:text-gray-300 dark:hover:text-white dark:hover:bg-white/5"
        aria-label="Reply"
        title="Reply"
        data-reply-button
        data-reply-to-id="{{ message.id }}"
        data-reply-author="{{ message.author.profile.name|default:message.author.username|escape }}"
        data-reply-preview="{% if message.poll_id and message.poll_view %}ðŸ“Š Poll{% if message.poll_view.question %}: {{ message.poll_view.question|escape }}{% endif %}{% elif message.body and message.body|slice:':5' == '[GIF]' %}GIF{% else %}{{ message.body|default:message.file_caption|default:message.filename|default:''|escape }}{% endif %}">
        <span class="text-base leading-none">â†©</span>
    </button>

    <button
        type="button"
        class="h-8 w-8 inline-flex items-center justify-center rounded-full border border-gray-300 bg-gray-200/90 text-gray-800 hover:bg-gray-300/90 transition duration-150 ease-out hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 dark:border-transparent dark:bg-transparent dark:text-gray-300 dark:hover:text-white dark:hover:bg-white/5"
        aria-label="Add reaction"
        title="Add reaction"
        data-reaction-toggle
        data-message-id="{{ message.id }}">
        <span class="text-base leading-none">+</span>
    </button>

    {% if message.author == user or user.is_staff %}
        <div class="relative">
            <button
                type="button"
                class="h-8 w-8 inline-flex items-center justify-center rounded-full border border-gray-300 bg-gray-200/90 text-gray-800 hover:bg-gray-300/90 transition duration-150 ease-out hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 dark:border-transparent dark:bg-transparent dark:text-gray-300 dark:hover:text-white dark:hover:bg-white/5"
                aria-label="Message actions"
                title="Actions"
                aria-haspopup="menu"
                aria-expanded="false"
                data-message-menu-toggle>
                <span class="text-base leading-none">â‹®</span>
            </button>

            <div class="hidden absolute bottom-full mb-2 right-0 min-w-28 rounded-xl border border-gray-800 bg-gray-900/95 shadow-lg shadow-black/20 overflow-hidden z-50" data-message-menu role="menu">
                {% if message.author == user and chat_group.is_private %}
                    <button
                        type="button"
                        hx-get="{% url 'message-info' message.id %}?modal=1"
                        hx-target="#global_modal_root"
                        hx-swap="innerHTML"
                        hx-push-url="false"
                        class="w-full text-left px-3 py-2 text-[11px] text-gray-200 hover:bg-gray-800/60"
                    >
                        Info
                    </button>
                {% endif %}
                {% if message.author == user and message.body and message.body|slice:":6" != "[CALL]" and message.body|slice:":5" != "[GIF]" and not message.file %}
                    <button type="button"
                        data-edit-message
                        data-message-id="{{ message.id }}"
                        data-message-body="{{ message.body|default:''|escape }}"
                        class="w-full text-left px-3 py-2 text-xs text-gray-200 hover:bg-gray-800/60">
                        Edit
                    </button>
                {% endif %}
                {% if not message.poll_id or not message.poll_view %}
                    {% if not message.body or message.body|slice:":5" != "[GIF]" %}
                        <button type="button"
                            data-copy-message
                            data-message-id="{{ message.id }}"
                            data-message-text="{{ message.body|default:message.file_caption|default:message.filename|default:''|escape }}"
                            class="w-full text-left px-3 py-2 text-xs text-gray-200 hover:bg-gray-800/60">
                            Copy
                        </button>
                    {% endif %}
                {% endif %}

                {% if message.author == user or user.is_staff %}
                    <button type="button"
                        data-delete-message
                        data-message-id="{{ message.id }}"
                        class="w-full text-left px-3 py-2 text-xs text-rose-200 hover:bg-rose-500/15">
                        Delete
                    </button>
                {% endif %}

                {% if user.is_staff and message.author != user and not message.author.is_superuser %}
                    <form method="post" action="{% url 'admin-user-toggle-block' message.author.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{% url 'chatroom' chat_group.group_name %}" />
                        <button type="submit"
                            class="w-full text-left px-3 py-2 text-[11px] text-gray-200 hover:bg-gray-800/60">
                            {% if message.author.profile.chat_blocked %}Unblock user{% else %}Block user{% endif %}
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <div class="hidden vixo-reaction-picker absolute bottom-full mb-2 left-1/2 -translate-x-1/2 items-center justify-center gap-1 rounded-2xl bg-transparent px-2 py-1 shadow-lg shadow-black/10 ring-1 ring-white/10 w-[min(18rem,calc(100vw-2rem))] max-w-full overflow-x-auto"
         data-reaction-picker
         data-message-id="{{ message.id }}">
        {% for emoji in reaction_emojis %}
            <button
                type="button"
                class="h-9 w-9 inline-flex items-center justify-center rounded-full text-gray-100 transition duration-150 ease-out hover:bg-gray-800/60 hover:scale-105 active:scale-95"
                data-react-emoji
                data-message-id="{{ message.id }}"
                data-emoji="{{ emoji }}">
                <span class="text-lg leading-tight">{{ emoji }}</span>
            </button>
        {% endfor %}
    </div>
</div>
