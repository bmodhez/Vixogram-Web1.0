{% load chat_extras %}

{% if message.body == "[SYSTEM_JOIN]" %}
    <div data-message-id="{{ message.id }}" class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-gray-700 bg-gray-800/60 px-3 py-1.5 text-[11px] font-medium text-gray-200/80">
                <span>
                    {% if message.author == user %}
                        You joined the group
                    {% else %}
                        {% with dn=message.author.profile.name|default:message.author.username %}{{ dn }}{% endwith %} joined the group
                    {% endif %}
                </span>
                <span class="text-gray-500">â€¢</span>
                {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                    {# Public groups: don't show message time #}
                {% else %}
                    <time class="text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>
                {% endif %}
            </div>
        </div>
    </div>
{% elif message.body == "[SYSTEM_LEFT]" %}
    <div data-message-id="{{ message.id }}" class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-gray-700 bg-gray-800/60 px-3 py-1.5 text-[11px] font-medium text-gray-200/80">
                <span>
                    {% if message.author == user %}
                        You have exited the group
                    {% else %}
                        This member has exited the group
                    {% endif %}
                </span>
                <span class="text-gray-500">â€¢</span>
                {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                    {# Public groups: don't show message time #}
                {% else %}
                    <time class="text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>
                {% endif %}
            </div>
        </div>
    </div>
{% elif message.body == "[SYSTEM_REMOVED]" %}
    <div data-message-id="{{ message.id }}" class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-gray-700 bg-gray-800/60 px-3 py-1.5 text-[11px] font-medium text-gray-200/80">
                <span>
                    {% if message.author == user %}
                        You were removed from the group
                    {% else %}
                        {% with dn=message.author.profile.name|default:message.author.username %}{{ dn }}{% endwith %} was removed from the group
                    {% endif %}
                </span>
                <span class="text-gray-500">â€¢</span>
                {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                    {# Public groups: don't show message time #}
                {% else %}
                    <time class="text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>
                {% endif %}
            </div>
        </div>
    </div>
{% elif message.body == "[SYSTEM_ADMIN_ADDED]" %}
    <div data-message-id="{{ message.id }}" class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-gray-700 bg-gray-800/60 px-3 py-1.5 text-[11px] font-medium text-gray-200/80">
                <span>
                    {% if message.author == user %}
                        You are now an admin
                    {% else %}
                        {% with dn=message.author.profile.name|default:message.author.username %}{{ dn }}{% endwith %} is now an admin
                    {% endif %}
                </span>
                <span class="text-gray-500">â€¢</span>
                {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                    {# Public groups: don't show message time #}
                {% else %}
                    <time class="text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>
                {% endif %}
            </div>
        </div>
    </div>
{% elif message.body == "[SYSTEM_ADMIN_REMOVED]" %}
    <div
        data-message-id="{{ message.id }}"
        data-system-admin-removed="1"
        data-system-admin-removed-self="{% if message.author == user %}1{% else %}0{% endif %}"
        class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-gray-700 bg-gray-800/60 px-3 py-1.5 text-[11px] font-medium text-gray-200/80">
                <span>
                    {% if message.author == user %}
                        You are no longer an admin
                    {% else %}
                        {% with dn=message.author.profile.name|default:message.author.username %}{{ dn }}{% endwith %} is no longer an admin
                    {% endif %}
                </span>
                <span class="text-gray-500">â€¢</span>
                {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                    {# Public groups: don't show message time #}
                {% else %}
                    <time class="text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>
                {% endif %}
            </div>
        </div>
    </div>
{% elif message.body == "[SYSTEM_ADMINS_ONLY_ENABLED]" %}
    <div data-message-id="{{ message.id }}" class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-gray-700 bg-gray-800/60 px-3 py-1.5 text-[11px] font-medium text-gray-200/80">
                <span>
                    {% if message.author == user %}
                        You have enabled admins only chat
                    {% else %}
                        {% with dn=message.author.profile.name|default:message.author.username %}{{ dn }}{% endwith %} has enabled admins only chat
                    {% endif %}
                </span>
                <span class="text-gray-500">â€¢</span>
                {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                    {# Public groups: don't show message time #}
                {% else %}
                    <time class="text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>
                {% endif %}
            </div>
        </div>
    </div>
{% elif message.body == "[SYSTEM_ADMINS_ONLY_DISABLED]" %}
    <div data-message-id="{{ message.id }}" class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-gray-700 bg-gray-800/60 px-3 py-1.5 text-[11px] font-medium text-gray-200/80">
                <span>
                    {% if message.author == user %}
                        You have disabled admins only chat
                    {% else %}
                        {% with dn=message.author.profile.name|default:message.author.username %}{{ dn }}{% endwith %} has disabled admins only chat
                    {% endif %}
                </span>
                <span class="text-gray-500">â€¢</span>
                {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                    {# Public groups: don't show message time #}
                {% else %}
                    <time class="text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>
                {% endif %}
            </div>
        </div>
    </div>
{% elif message.body and message.body|slice:":6" == "[CALL]" %}
    <div data-message-id="{{ message.id }}" class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-gray-700 bg-gray-800/60 px-3 py-1.5 text-[11px] font-medium text-gray-200/80">
                <span>{{ message.body|cut:"[CALL] " }}</span>
                <span class="text-gray-500">â€¢</span>
                {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                    {# Public groups: don't show message time #}
                {% else %}
                    <time class="text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>
                {% endif %}
            </div>
        </div>
    </div>
{% elif message.body and message.body|slice:":13" == "[SYSTEM_TAG] " %}
    <div data-message-id="{{ message.id }}" class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-gray-700 bg-gray-800/60 px-3 py-1.5 text-[11px] font-medium text-gray-200/80">
                <span>{{ message.body|cut:"[SYSTEM_TAG] " }}</span>
                <span class="text-gray-500">â€¢</span>
                {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                    {# Public groups: don't show message time #}
                {% else %}
                    <time class="text-gray-400/70" data-dt="{{ message.created|date:'c' }}"></time>
                {% endif %}
            </div>
        </div>
    </div>
{% elif message.body == "[MOD_HIDDEN]" %}
    <div data-message-id="{{ message.id }}" class="flex justify-center{% if extra_classes %} {{ extra_classes }}{% endif %}">
        <div class="max-w-[90%]">
            <div class="inline-flex items-center gap-2 rounded-full border border-rose-400/35 bg-rose-500/10 px-3 py-1.5 text-[11px] font-medium text-rose-100/90">
                <span>Message hidden by Vixogram moderators</span>
                <span aria-hidden="true" title="Blocked">ðŸš«</span>
                <span class="text-rose-200/50">â€¢</span>
                {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                    {# Public groups: don't show message time #}
                {% else %}
                    <time class="text-rose-100/60" data-dt="{{ message.created|date:'c' }}"></time>
                {% endif %}
            </div>
        </div>
    </div>
{% else %}
<div id="msg-{{ message.id }}" data-message-id="{{ message.id }}" data-author-id="{{ message.author_id }}" class="vixo-msg group relative w-full flex {% if message.author == user %}justify-end{% else %}justify-start{% endif %}{% if extra_classes %} {{ extra_classes }}{% endif %}">
    <div class="flex flex-col {% if message.author == user %}items-end{% else %}items-start{% endif %} max-w-[90%] sm:max-w-[75%] lg:max-w-[65%]">

        <div data-message-header class="mb-0.5 px-1 w-full{% if prev_message and prev_message.author_id == message.author_id %} hidden{% endif %}">
            <div class="flex items-center gap-2">
                {% if message.author != user %}
                    <a
                        href="{% url 'profile-user' message.author.username %}"
                        hx-get="{% url 'profile-user' message.author.username %}?modal=1"
                        hx-target="#global_modal_root"
                        hx-swap="innerHTML"
                        hx-push-url="false"
                        class="inline-flex items-center gap-2 min-w-0"
                    >
                        <img src="{{ message.author.profile.avatar }}" class="w-6 h-6 rounded-full object-cover border border-white/10">
                        {% if message.author.is_superuser %}
                            <span data-vixo-name="{{ message.author.profile.name|default:message.author.username|escape }}" class="text-[14px] font-semibold text-gray-100 vixo-superuser-name-shock {% if message.author.profile.name_glow_color and message.author.profile.name_glow_color != 'none' %}vixo-user-glow-{{ message.author.profile.name_glow_color }}{% endif %}" title="Verified superuser">
                                {{ message.author.profile.name|default:message.author.username }}
                            </span>
                            <span class="vixo-superuser-verified-badge" aria-label="Verified" title="Verified superuser">âœ“</span>
                        {% else %}
                            <span class="text-[14px] font-semibold truncate text-gray-200 {% if message.author.profile.name_glow_color and message.author.profile.name_glow_color != 'none' %}vixo-user-glow-{{ message.author.profile.name_glow_color }}{% endif %}">
                                {{ message.author.profile.name|default:message.author.username }}
                            </span>
                        {% endif %}
                    </a>
                {% else %}
                    <span class="text-[14px] font-semibold inline-flex items-center gap-2">
                        {% if message.author.is_superuser %}
                            <span data-vixo-name="{{ message.author.profile.name|default:message.author.username|escape }}" class="text-gray-100 vixo-superuser-name-shock {% if message.author.profile.name_glow_color and message.author.profile.name_glow_color != 'none' %}vixo-user-glow-{{ message.author.profile.name_glow_color }}{% endif %}" title="Verified superuser">
                                {{ message.author.profile.name|default:message.author.username }}
                            </span>
                            <span class="vixo-superuser-verified-badge" aria-label="Verified" title="Verified superuser">âœ“</span>
                        {% else %}
                            <span class="text-gray-200 {% if message.author.profile.name_glow_color and message.author.profile.name_glow_color != 'none' %}vixo-user-glow-{{ message.author.profile.name_glow_color }}{% endif %}">
                                {{ message.author.profile.name|default:message.author.username }}
                            </span>
                        {% endif %}
                        <span class="text-[11px] text-gray-400/70">(you)</span>
                    </span>
                {% endif %}

                {# Time moved into bubble footer (WhatsApp-like) #}
            </div>

            {% comment %}
            {% if message.auto_badges %}
                <div class="mt-1 flex flex-wrap gap-1">
                    {% for b in message.auto_badges %}
                        <span class="inline-flex items-center gap-1 rounded-full border border-gray-800 bg-gray-900/50 px-2 py-0.5 text-[11px] text-gray-200/80">
                            <span aria-hidden="true">{{ b.icon }}</span>
                            <span>{{ b.label }}</span>
                        </span>
                    {% endfor %}
                </div>
            {% endif %}
            {% endcomment %}
        </div>

        <div class="flex items-end gap-2">
            {% if message.author == user %}
                {% include 'a_rtchat/partials/reaction_picker.html' %}
            {% endif %}

            <div data-message-bubble class="relative min-w-0 max-w-full {% if message.poll_id or message.body and message.body|slice:':5' == '[GIF]' or message.is_image or message.is_video %}p-0 bg-transparent border-0 shadow-none backdrop-blur-none{% else %}px-3 py-2.5 rounded-2xl shadow-sm shadow-black/20 backdrop-blur-md {% if message.author == user %}bg-gradient-to-r from-purple-500 via-indigo-500 to-sky-500 text-white vixo-keep-white rounded-tr-none border border-white/10{% else %}bg-white/5 text-gray-100 border border-white/10 rounded-tl-none{% endif %}{% endif %}">

                {% if message.reply_to %}
                    <button type="button" data-scroll-to="msg-{{ message.reply_to.id }}" class="block w-full max-w-full min-w-0 text-left mb-1.5" style="max-width:100%;overflow:hidden;">
                        <div class="px-3 py-1.5 rounded-xl border-l-2 border-indigo-300/70 bg-white/5 min-w-0 max-w-full overflow-hidden" style="max-width:100%;overflow:hidden;">
                            <div class="text-[10px] font-semibold text-gray-200/80">
                                Replying to {{ message.reply_to.author.profile.name|default:message.reply_to.author.username }}
                            </div>
                            <div class="block min-w-0 max-w-full overflow-hidden text-ellipsis whitespace-nowrap text-[11px] text-gray-100/80" style="display:block;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                                {% if message.reply_to.poll_id and message.reply_to.poll %}
                                    ðŸ“Š Poll{% if message.reply_to.poll.question %}: {{ message.reply_to.poll.question|truncatechars:80 }}{% endif %}
                                {% elif message.reply_to.body %}
                                    {% if message.reply_to.body|slice:":5" == "[GIF]" %}
                                        {% with gif_url=message.reply_to.body|slice:"5:"|cut:" " %}
                                            <span class="inline-flex items-center gap-2">
                                                <img src="{{ gif_url|giphy_still_url }}" alt="GIF" class="h-6 w-10 rounded-md object-cover border border-white/10" loading="lazy" decoding="async" />
                                                <span class="text-[11px] text-gray-100/80">GIF</span>
                                            </span>
                                        {% endwith %}
                                    {% else %}
                                        {{ message.reply_to.body|striptags|truncatechars:90 }}
                                    {% endif %}
                                {% elif message.reply_to.file %}
                                    {{ message.reply_to.filename|truncatechars:90 }}
                                {% endif %}
                            </div>
                        </div>
                    </button>
                {% endif %}
                <div class="vixo-msg-text text-[14px] sm:text-[15px] leading-relaxed text-white/95{% if message.author == user %} vixo-keep-white{% endif %}">{% include 'a_rtchat/partials/message_content.html' %}</div>

                <div class="mt-1 flex items-end justify-end gap-1 text-[11px] {% if message.author == user %}text-white/80{% else %}text-gray-300/80{% endif %}">
                    {% if message.edited_at %}
                        <span class="opacity-70">edited</span>
                    {% endif %}
                    {% if chat_group and not chat_group.is_private and not chat_group.is_code_room %}
                        {# Public groups: don't show message time #}
                    {% else %}
                        <time data-dt="{{ message.created|date:'c' }}"></time>
                    {% endif %}
                    {% if message.author == user and chat_group.is_private %}
                        {% with other_read=other_last_read_id|default:0 %}
                            <span class="ml-0.5" data-read-tick data-message-id="{{ message.id }}">
                                {% if other_read >= message.id %}âœ“âœ“{% else %}âœ“{% endif %}
                            </span>
                        {% endwith %}
                    {% endif %}
                </div>

                {% if message.link_url %}
                    <a href="{{ message.link_url }}" target="_blank" rel="noopener noreferrer"
                       class="mt-3 block rounded-xl border border-gray-800 bg-gray-950/30 overflow-hidden hover:bg-gray-800/30 transition-colors">
                        {% if message.link_image %}
                            <img src="{{ message.link_image }}" alt="" class="w-full h-36 object-cover" loading="lazy" />
                        {% endif %}
                        <div class="p-3">
                            {% if message.link_site_name %}
                                <div class="text-[10px] uppercase tracking-widest text-gray-400 mb-1">{{ message.link_site_name }}</div>
                            {% endif %}
                            {% if message.link_title %}
                                <div class="text-sm font-semibold text-gray-100 line-clamp-2">{{ message.link_title }}</div>
                            {% else %}
                                <div class="text-sm font-semibold text-gray-100 break-all">{{ message.link_url|slice:":80" }}</div>
                            {% endif %}
                            {% if message.link_description %}
                                <div class="text-xs text-gray-300 mt-1 line-clamp-3">{{ message.link_description }}</div>
                            {% endif %}
                        </div>
                    </a>
                {% endif %}
            </div>

            {% if message.author != user %}
                {% include 'a_rtchat/partials/reaction_picker.html' %}
            {% endif %}
        </div>

        {% include 'a_rtchat/partials/reactions_bar.html' %}
        
        {# Ticks/time moved into bubble footer #}
    </div>
</div>
{% endif %}